
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Урок 8. Retrieval‑Augmented Generation (RAG) &#8212; Knowledge base</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'temp/lesson8';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.jpg" class="logo__image only-light" alt="Knowledge base - Home"/>
    <script>document.write(`<img src="../_static/logo.jpg" class="logo__image only-dark" alt="Knowledge base - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Knowlege
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Data science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_science/intro.html">Data science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_science/gradient_descent.html">Gradient descent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_science/decision_tree.html">Decision tree</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_science/model_selection.html">Model selection</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_science/model_selection/regularization.html">Regularization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_science/metrics.html">Metrics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../data_science/metrics/classification.html">Classification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_science/metrics/classification/confusion_matrix.html">Confusion matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/metrics/classification/cross_entropy.html">Cross entropy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/metrics/classification/CAP.html">CAP curve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/metrics/classification/GINI.html">GINI coeficient</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/metrics/model_interpretation.html">Model interpretation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/metrics/pearson_correlation.html">Pearson correlation coefficient</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/metrics/jaccard_index.html">Jaccard index</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_science/ranking_task.html">Ranking task</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../data_science/ranking_task/collaborative_filtering.html">Collaborative filtering</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_science/ranking_task/collaborative_filtering/prediction_functions.html">Prediction functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/ranking_task/collaborative_filtering/self_made_mem_based.html">Selfmade memory based</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/ranking_task/task_generation.html">Task generation</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../data_science/ranking_task/metrics.html">Metrics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_science/ranking_task/metrics/precision_k.html">precision@k</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/ranking_task/metrics/recall_k.html">recall@k</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/ranking_task/metrics/average_precision.html">AP@k (average precision)</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_science/nlp.html">NLP</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../data_science/nlp/preprocessing.html">Pre-Processing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_science/nlp/preprocessing/tokenization.html">Tokenization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/nlp/preprocessing/embeddings.html">Embeddings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_science/nlp/preprocessing/tf_idf.html">TF-IDF</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/nlp/text_cnn.html">Text CNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/nlp/recurrent_text_gen.html">Recurrent text gen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/nlp/recurrent_translation.html">Recurrent translations</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../data_science/nlp/LLMs.html">LLMs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_science/nlp/LLMs/rag/imdb_example.html">IMDB example</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_science/dl_mechanisms.html">DL mechanisms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_science/dl_mechanisms/recurrent.html">Recurrent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/dl_mechanisms/attention.html">Attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_science/dl_mechanisms/transformer.html">Transformer</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Math</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../math/introduction.html">Intorduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../math/geometry.html">Geometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../math/geometry/triangle.html">Triangle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math/geometry/cone.html">Cone</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../math/trigonometry.html">Trigonometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../math/trigonometry/identities.html">Identities</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../math/mat_stat.html">MatStat</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../math/mat_stat/probability.html">Probability</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../math/mat_stat/probability/conditional_probability.html">Сonditional probability</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../math/mat_stat/distributions.html">Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math/mat_stat/cent_limit_theorem.html">Central limit theorem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math/mat_stat/maximum_likelihood.html">Maximum likelihood</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../math/mat_stat/stat_testing.html">Statistical testing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../math/mat_stat/stat_testing/t_test.html">T-test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../math/mat_stat/stat_testing/binomial_test.html">Binomial test</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../math/latex.html">Latex</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../algorithms/intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/complexity.html">Complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/binary_search.html">Binary search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/event_sort.html">Event sort</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../algorithms/data_structures.html">Data structures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../algorithms/data_structures/binary_search_trees.html">Binary search trees</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/dynamic_prog.html">Dynamic programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms/quick_sort.html">Quick sort</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../algorithms/specific_tasks.html">Specific tasks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../algorithms/specific_tasks/emergency_task.html">Emergency task</a></li>
<li class="toctree-l2"><a class="reference internal" href="../algorithms/specific_tasks/sinking_islands.html">Sinling islands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../algorithms/specific_tasks/number_reversal.html">Number reversal</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Docker</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../docker/overview.html">Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../docker/containers.html">Containers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../docker/containers/run.html">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docker/containers/execute_in.html">Execute in</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docker/containers/check_logs.html">Check logs</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../docker/images.html">Images</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../docker/images/build_image.html">Build image</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../docker/images/build_image/build_context.html">Build context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../docker/images/build_image/ignore_files.html">Ignore files</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../docker/images/docker_file_directives.html">Dockerfile directives</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../docker/images/docker_file_directives/execute_with_run.html">Execute with start</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/volumes.html">Volumes</a></li>

<li class="toctree-l1 has-children"><a class="reference internal" href="../docker/networks.html">Networks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../docker/networks/default_networks.html">Default networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docker/networks/container_communication.html">Containers communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docker/networks/local_network.html">Local network</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/access.html">Acesss to containers</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../docker/compose.html">Compose</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../docker/compose/up_down.html">Up/down</a></li>

<li class="toctree-l2"><a class="reference internal" href="../docker/compose/service_configuration.html">Service configuration</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Git</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../git/overview.html">Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../git/file_stages.html">File statuses</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../git/file_stages/commit.html">Commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git/file_stages/remove_from_staging.html">Remove from staging</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../git/diff.html">Difference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/checkout.html">Checkout</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../git/branches.html">Branches</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../git/branches/merge.html">Merge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git/branches/remote.html">Remotes</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../git/log.html">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/previous_commit.html">Previous commit <code class="docutils literal notranslate"><span class="pre">~</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/ignore.html">How git ignore works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/stash.html">Stash</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../git/configuration.html">Configuration</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../git/configuration/variables.html">Variables</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SQL</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sql/intro.html">Intro</a></li>

<li class="toctree-l1 has-children"><a class="reference internal" href="../sql/select.html">Select</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sql/select/join.html">JOIN</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../sql/select/join/join_types.html">Join types</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/sorting.html">Sorting (ORDER BY)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/unique_values.html">Unique values (DISTINCT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/empty_values.html">Empty values</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sql/select/aggregation_functions.html">Aggregation functions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../sql/select/aggregation_functions/collect_array.html">Collect array</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sql/select/group_by.html">Group by</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../sql/select/group_by/conditions_on_aggregats.html">Conditions on aggregats (HAVING)</a></li>



</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sql/select/window_functions.html">Window functions (OVER)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../sql/select/window_functions/functions.html">Functions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../sql/select/window_functions/functions/value.html">Value</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/expand_array.html">Expand array</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/conditional.html">Conditional (CASE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/records_range.html">Records range (OFFSET/LIMIT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/select/performance.html">Performance</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../sql/operating_tables.html">Operating tables</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../sql/operating_tables/tables_properties.html">Tables properties</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../sql/datatypes.html">Data types</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sql/datatypes/datetime.html">Date and time</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../sql/datatypes/datetime/date_components.html">Date components (DATE_PART)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sql/datatypes/datetime/add_period.html">Add period</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/datatypes/json.html">JSON</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../sql/load_modify.html">Load/Modify</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sql/versions_issues.html">Versions issues</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../sql/python_interaction.html">Python interaction</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../sql/python_interaction/python_from_container.html">Python from container</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/python_interaction/python_on_host.html">Python on host</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sql/python_interaction/create_database.html">Create database</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Layout</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../layout/terminology.html">Terminology</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../layout/html.html">HTML</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../layout/html/other.html">Other</a></li>



<li class="toctree-l2"><a class="reference internal" href="../layout/html/text_format.html">Text format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/html/tables.html">Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/html/lists.html">List tags</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../layout/html/svg.html">SVG</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../layout/html/svg/text.html">Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../layout/html/svg/path.html">Path</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../layout/css.html">CSS</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../layout/css/other.html">Other</a></li>







<li class="toctree-l2"><a class="reference internal" href="../layout/css/style_application.html">Style application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/css/margin.html">Margin (out space)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/css/padding.html">Padding (in space)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/css/overflow.html">Overflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/css/elements_positions.html">Elements position (<code class="docutils literal notranslate"><span class="pre">display</span></code>)</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/forms.html">Forms</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Linux</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../linux/intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/bash.html">Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/manage_input_output.html">Manage input/output</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../linux/filesystem.html">Filesystem</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../linux/filesystem/files_directories.html">Files and directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linux/filesystem/archiving.html">Archiving</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/variables.html">Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/system_information.html">System information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/backup.html">Backup</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../linux/network.html">Network</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../linux/network/curl.html">Curl</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../linux/network/ssh.html">SSH</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../linux/network/ssh/generate_key.html">Generate key</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../linux/network/netcat_nc.html">Netcat (<code class="docutils literal notranslate"><span class="pre">nc</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linux/network/vpn.html">VPN</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../linux/users_groups.html">Users &amp; groups</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../linux/users_groups/user_management.html">User management</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/package_management.html">Package management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/path.html">Path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/cron.html">Cron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/gnupg.html">GnuPG</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../other/vs_code.html">VS Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/python_apache.html">Python with apache</a></li>







<li class="toctree-l1"><a class="reference internal" href="../other/kubernetes.html">Kubernetes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../other/redis.html">Redis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../other/redis/zset.html">Zset</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../other/nginx.html">Nginx</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../other/nginx/reverse_proxy.html">Reverse proxy</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../other/nginx/reverse_proxy/proxy_pass.html">Proxy pass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other/nginx/reverse_proxy/cache.html">Cache</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../other/nginx/variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other/nginx/server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other/nginx/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other/nginx/logs.html">Logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other/nginx/connections_management.html">Connections management</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../other/gitlab.html">Gitlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/ansible.html">Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/java_script.html">Java script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/go_templates.html">Go templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/kafka.html">Kafka</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/elastic_search.html">Elastic search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/clouds.html">Clouds</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/fedorkobak/knowledge" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/temp/lesson8.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Урок 8. Retrieval‑Augmented Generation (RAG)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Урок 8. Retrieval‑Augmented Generation (RAG)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">План</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Загрузка датасета и модели</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rag">Генерация без RAG</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#retrievalaugmented-generation">Retrieval‑Augmented Generation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">RAG на отзывах</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Добавляем названия фильмов</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reranker">Reranker</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-query">Multi-Query</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Фильтры</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Резюме</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="retrievalaugmented-generation-rag">
<h1>Урок 8. Retrieval‑Augmented Generation (RAG)<a class="headerlink" href="#retrievalaugmented-generation-rag" title="Link to this heading">#</a></h1>
<p>В этом уроке мы сделаем из LLM ассистента, который сможет отвечать на русском на произвольные вопросы о фильмах. Для этого мы будем использовать RAG и датасет с отзывами от Кинопоиска.</p>
<section id="id1">
<h2>План<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Как модель работает без RAG?</p></li>
<li><p>Строим RAG на отзывах</p></li>
<li><p>Reranker</p></li>
<li><p>Multi-Query</p></li>
<li><p>Фильтрация по мета-информации</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h2>Загрузка датасета и модели<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Скачаем <a class="reference external" href="https://huggingface.co/datasets/blinoff/kinopoisk">датасет</a> из HugingFace Hub. Он содержит больше 35 тысяч отзывов пользователей на различные фильмы.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_dataset</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\xa0</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;blinoff/kinopoisk&quot;</span><span class="p">)[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4b76a1d3182f4515881319febea6871f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6c1586cd703e4379a788824c678817c9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "15198df26a9b4cd2b5f53b108af6f9da", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fe52c4945e594589b55b62a1bd24174a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;part&#39;, &#39;movie_name&#39;, &#39;review_id&#39;, &#39;author&#39;, &#39;date&#39;, &#39;title&#39;, &#39;grade3&#39;, &#39;grade10&#39;, &#39;content&#39;],
    num_rows: 36591
})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Блеф (1976)&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&quot;Блеф» — одна из моих самых любимых комедий.\n\nЭтот фильм я наверно смотрел раз сто, нет я конечно блефую, я видел его куда больше. Не могу не выразить своё восхищение главными действующими лицами этого фильма. Начну с Адриано Челентано для которого как я считаю это лучшая роль в кино. Великолепный актёр, неплохой певец, странно что на его родине в Италии его песни мало кто слушает. Ну я думаю что и итальянцы и французы привыкли к тому, что у нас до сих их актёры популярней чем даже на своей родине. Да, такой вот парадокс. Челентано конечно профессионал своего дела, комик с серьёзным выражением лица. Он смешон ещё и потому, что одновременно так серъёзен. Адриано браво!\n\nА теперь несколько слов об Энтони Куине. Да тот самый горбун из Нотр-дама. Собор Парижской Богоматери, оригинальная версия, кто не смотрел рекомендую. С ним как-то приключилась одна интересная история. На съёмках одного из своих фильмов он то ли сломал, то ли подвихнул ногу, а роль требовала от него чтобы в одной из сцен он кружился с дамой в танце. И он вместе со съёмочным коллективом вышел из этого положения. Они сделали вращающеюся платформу, которая создавала видимость того, что он весь в ритме танца. Вот такая вот история, к слову об этом замечательном актёре.\n\nНу и теперь сам фильм, жанр которой можно смело обозвать авантюрой. Комедийной авантюрой. Некая Белль Дьюк, весьма влиятельная дама, пытается освободить своего старого знакомого авантюриста Филиппа Бенга, у которого с ней давние счёты. Но вместо него на свободе оказывается другой комбинатор-аферист по имени Феликс. И чтобы не быть битым головорезами Белль Дьюк, он уже сам разрабатывает план побега Бэнга. После того как они встречаются череда смешных сцен заставит зрителя разразиться шквальным смехом. В их умений блефовать, им просто нет равных. Главное правило чтобы блеф сработал, надо самому в него поверить. Помимо всего этого они ещё и соревнуются в стратегий блефа. Некоторые сцены их обмана запомнились мне надолго, особенно сцена в магазине тканей: \n\n — Привет старина. Так тебя выпустили из лепрозория?\n — Не совсем, я оттуда сбежал.\n\nНу или финальная сцена, которую можно охарактеризовать тремя словами; смех сквозь слёзы.\n\nВ завершении скажу, что это великолепное кино можно смотреть и пересматривать очень много раз, и оно не потеряет своего шарма и обаяния.\n\n10 из 10&#39;
</pre></div>
</div>
</div>
</div>
<p>Мы будем проводить все испытания с моделью <a class="reference external" href="https://huggingface.co/Qwen/Qwen2-1.5B-Instruct"><code class="docutils literal notranslate"><span class="pre">Qwen/Qwen2-1.5B-Instruct</span></code></a>. Это вопросно-ответная модель на основе GPT, которая обучалась на большом количестве языков, в том числе на русском.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">generation_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
    <span class="s2">&quot;text-generation&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Qwen/Qwen2-1.5B-Instruct&quot;</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8adfd1102b094e3396ae802ecc0e1941", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`torch_dtype` is deprecated! Use `dtype` instead!
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7624b0f88ea34ea7ad342e533a6af0d5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b56ed9ff4d404cd9ba3b4bef90da51da", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1e8878f174a54d28ab4027f0deb57006", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "922561817bee42929443d31942ff6e22", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fd4d01f116fb4d169e2e2c034481ea3b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a306bb4ab5754c64811a43349aacf749", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Device set to use cpu
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="rag">
<h1>Генерация без RAG<a class="headerlink" href="#rag" title="Link to this heading">#</a></h1>
<p>Проверим, насколько хорошо модель отвечает на вопросы без использования RAG.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;В каких пяти фильмах играл Роберт де Ниро?&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">generation_pipeline</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">answer</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Роберт Де Ниро сыграл в следующих пяти фильмах:

1. &quot;Мстители&quot; (2019)
2. &quot;Ингредиенты для успеха&quot; (2018)
3. &quot;Комбат: Заговор&quot; (2016)
4. &quot;Доктор ужасен&quot; (2015)
5. &quot;Путешествие на Луну&quot; (2017)
</pre></div>
</div>
</div>
</div>
<p>Видим, что знаний модели не хватает. Все названия, кроме Терминатора, отсылают к несуществующим фильмам, а в Терминаторе Роберт де Ниро не играл.</p>
</section>
<section id="retrievalaugmented-generation">
<h1>Retrieval‑Augmented Generation<a class="headerlink" href="#retrievalaugmented-generation" title="Link to this heading">#</a></h1>
<p>Попробуем улучшить качество модели с помощью RAG. Для этого нам сперва надо составить векторную базу данных. В качестве эмбеддинговой модели будем использовать <a class="reference external" href="https://huggingface.co/intfloat/multilingual-e5-large"><code class="docutils literal notranslate"><span class="pre">intfloat/multilingual-e5-large</span></code></a>. Это большая мультиязычная модель на основе Encoder’a Трансформера.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>

<span class="n">embedding_model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s2">&quot;intfloat/multilingual-e5-large&quot;</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;torch_dtype&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`torch_dtype` is deprecated! Use `dtype` instead!
</pre></div>
</div>
</div>
</div>
<p>Мы построим нашу базу данных на основе инструмента <a class="reference external" href="https://github.com/qdrant/qdrant-client"><code class="docutils literal notranslate"><span class="pre">Qdrant</span></code></a>. В нем реализованы различные методы для поиска текстов, так что не придется писать ничего руками. Достаточно передать векторы эмбеддингов.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qdrant_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">QdrantClient</span><span class="p">,</span> <span class="n">models</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">QdrantClient</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;kinopoisk_e5&quot;</span><span class="p">,</span>
    <span class="n">on_disk_payload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vectors_config</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">VectorParams</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Distance</span><span class="o">.</span><span class="n">COSINE</span><span class="p">,</span>
        <span class="n">on_disk</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Для разбиения текста на куски используем <code class="docutils literal notranslate"><span class="pre">RecursiveCharacterTextSplitter</span></code> из библиотеки <a class="reference external" href="https://github.com/langchain-ai/langchain"><code class="docutils literal notranslate"><span class="pre">langchain</span></code></a>. Мы будем делить текст на куски примерно по 1000 символов рекурсивно.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>

<span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Собираем векторную базу данных.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ans</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))):</span>
    <span class="c1"># разбиваем текст на куски</span>
    <span class="n">text_chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>

    <span class="c1"># кодируем все куски в эмбеддинги</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># добавляем результат в базу данных</span>
    <span class="n">client</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;kinopoisk_e5&#39;</span><span class="p">,</span>
        <span class="n">points</span><span class="o">=</span><span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">PointStruct</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="n">vector</span><span class="o">=</span><span class="n">vectors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
                    <span class="c1"># дополнительно сохраняем сам текст, название фильма и год выпуска</span>
                    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text_chunks</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;movie_name&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;movie_name&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">7</span><span class="p">],</span>
                    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;movie_name&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Проверим, насколько хорошо ищутся похожие по смыслу тексты.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_vector</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hits</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;kinopoisk_e5&quot;</span><span class="p">,</span>
    <span class="n">query_vector</span><span class="o">=</span><span class="n">query_vector</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">payload</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;text&#39;: &#39;Хороший фильм. На реальных событиях. Игра де Ниро восхищает. Робин Уильямс как обычно смешной и трагический.&#39;,
  &#39;movie_name&#39;: &#39;Пробуждение&#39;,
  &#39;year&#39;: 1990},
 {&#39;text&#39;: &#39;Потрясающий фильм. Великолепная игра Роберта Де Ниро. Изумительная по красоте и, как нельзя подходящая к этой кинокартине, музыка Эннио Морриконе. Этот шедевр стоит того, чтобы смотреть и смотреть не один раз.&#39;,
  &#39;movie_name&#39;: &#39;Однажды в Америке&#39;,
  &#39;year&#39;: 1983},
 {&#39;text&#39;: &#39;После долгих и продуктивных лет работы в качестве актера, Роберт де Ниро решил попробовать себя и в режиссерском поприще. Первый фильм этого гениального человека собрал в Америке больше 17 миллионов долларов. Интригующее повествование о судьбе обычного молодого парня, которому предстоит сделать самый важный шаг в своей жизни и, тем самым выбрать свой дальнейший путь существования, пришлось зрителю по душе. Семейная драма то и дело перекрикивается с гангстерским эпосом, и это делает фильм просто уникальным. Добавьте сюда щепотку романтики и незабываемые прелести первой любви — и фильм обречен на успех и зрительскую симпатию&#39;,
  &#39;movie_name&#39;: &#39;Бронкская история&#39;,
  &#39;year&#39;: 1993},
 {&#39;text&#39;: &#39;Роберт де Ниро сыграл потрясающую роль, передал всю боль, все счастье, все отчаяние больного.\n\nЭтот фильм должен посмотреть каждый. Возможно, кто-то сможет «пробудиться» к настоящей жизни.\n\n9 из 10&#39;,
  &#39;movie_name&#39;: &#39;Пробуждение&#39;,
  &#39;year&#39;: 1990},
 {&#39;text&#39;: &#39;Один из лучших боевиков увиденных мною. Когда играют такие актеры, шансы, что фильм получится плохим, приравниваются к нулю.\n\nБольше всего мне понравилась игра Роберта Де Ниро, который находится на грани добра и зла. А чего только стоит сцена перестрелки после ограбления банка.\n\n10 из 10&#39;,
  &#39;movie_name&#39;: &#39;Схватка&#39;,
  &#39;year&#39;: 1995}]
</pre></div>
</div>
</div>
</div>
<p>Ура! Все полученные тексты связаны с Робертом де Ниро. Теперь обернем этот процесс поиска в функцию.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query_vector</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">hits</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;kinopoisk_e5&quot;</span><span class="p">,</span>
        <span class="n">query_vector</span><span class="o">=</span><span class="n">query_vector</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
    <span class="p">)</span>
    <span class="n">relevant_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">payload</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">relevant_chunks</span>
</pre></div>
</div>
</div>
</div>
<section id="id3">
<h2>RAG на отзывах<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>Для реализации RAG будем передавать в контекст модели отзывы, относящиеся к запросу.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Ты русскоязычный эксперт в области кинематографа. У тебя есть доступ к набору отзывов о фильмах, используй их, чтобы полно и точно ответить на следующий вопрос. Убедись, что ответ подробный, конкретный и непосредственно касается вопроса. Не добавляй информацию, которая не подтверждается предоставленными отзывами.</span>

<span class="s2">Вопрос:</span>
<span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">Отзывы:</span>
<span class="si">{</span><span class="n">context</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">generation_pipeline</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">selected_chunks</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Роберт де Ниро играл в следующих пяти фильмах:

1. &quot;Загадочный человек&quot; (The Departed)
2. &quot;Огонь&quot; (Heat)
3. &quot;Тайны семьи&quot; (The Departed)
4. &quot;Алиса в стране чудес&quot; (Alice in Wonderland)
5. &quot;Мстители&quot; (Captain America: Civil War)
</pre></div>
</div>
</div>
</div>
<p>Несмотря не подсказки, получилось так себе. Дело в том, что отзывы очень редко содержат сами названия фильмов. Попробуем добавить их тоже контекст.</p>
</section>
<section id="id4">
<h2>Добавляем названия фильмов<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Название: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">selected_chunks</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Роберт де Ниро играл в следующих пяти фильмах:

1. Пробуждение (2006) - отзыв: &quot;Хороший фильм. На реальных событиях. Игра де Ниро восхищает. Робин Уильямс как обычно смешной и трагический.&quot;
2. Однажды в Америке (1999) - отзыв: &quot;Уникальный фильм. Игра Роберта Де Ниро не может не вызвать восхищения. Он действительно великолепен.&quot;
3. Пробуждение (2006) - отзыв: &quot;Фильм о пробуждении души того человека, который пробудил физически больных &#39;хроников&#39;.&quot;
4. Бронкская история (2005) - отзыв: &quot;Богатейший актерский опыт Роберта Де Ниро с такими авторитетными режиссерами криминальных драм как Мартин Скорцезе, Брайан Де Пальма, Френсис Форд Коппола просто не мог пройти даром. И талантливый актер сделал не менее изящный, подобно десятку своих ролей, режиссерский дебют картиной &#39;Бронкская история&#39;.&quot;
5. Схватка (2001) - отзыв: &quot;Отдельно стоит упомянуть два эпизода фильма — перестрелку на улице и финальную разборку Аль Пачино с Де Ниро. Это действительно круто. Как в самом крутом боевике.&quot;
</pre></div>
</div>
</div>
</div>
<p>Теперь модель возвращает все фильмы, в которых Роберт де Ниро действительно играл.</p>
</section>
</section>
<section id="reranker">
<h1>Reranker<a class="headerlink" href="#reranker" title="Link to this heading">#</a></h1>
<p>Давайте попробуем улучшить метод, добавив переранжирование отзызов.</p>
<img src="https://i.ibb.co/txhQby0/reranker.png" alt="drawing" width="700"/>
<p>Reranker – это языковая модель, принимающая два текста и возвращающая близость между ними.</p>
<img src="https://i.ibb.co/RcPGVs5/reranker-model.png" alt="drawing" width="200"/>
<p>В качестве реранкера мы будем использовать специальную мультиязычную модель, обученную для этих целей <a class="reference external" href="https://huggingface.co/amberoad/bert-multilingual-passage-reranking-msmarco"><code class="docutils literal notranslate"><span class="pre">amberoad/bert-multilingual-passage-reranking-msmarco</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.cross_encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">HuggingFaceCrossEncoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cross_encoder</span> <span class="o">=</span> <span class="n">HuggingFaceCrossEncoder</span><span class="p">(</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;amberoad/bert-multilingual-passage-reranking-msmarco&#39;</span><span class="p">,</span>
    <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;cpu&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cross_encoder</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>167357954
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Название: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">selected_chunks</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_encoder</span><span class="o">.</span><span class="n">score</span><span class="p">([(</span><span class="n">query</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">])</span>
    
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">))[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">context</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">answer</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>В фильмах, в которых играл Роберт де Ниро:

1. Бронкская история
2. Однажды в Америке 
3. Пробуждение
4. Военный ныряльщик
5. Крестный отец 2
</pre></div>
</div>
</div>
</div>
<p>Стало действительно немного лучше.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; ; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Название: Бронкская история. Отзыв: Богатейший актерский опыт Роберта Де Ниро с такими авторитетными режиссерами криминальных драм как Мартин Скорцезе, Брайан Де Пальма, Френсис Форд Коппола просто не мог пройти даром. И талантливый актер сделал не менее изящный, подобно десятку своих ролей, режиссерский дебют картиной «Бронкская история».\n\nСыграв также одну из второстепенных ролей, Роберт Де Ниро подарил необычный ему образ правильного и положительного героя, который из всех сил пытается вырастить в своем сыне мужество и справедливость. Ровно, как и герой Чазза Пальминтери, «крестного отца» итальянского квартала, которого, собственно больше боятся, чем любят. \n\nНо и герой Чазза Пальминтери по-своему прав, взяв на воспитание сына Лоренцо, он не утаивает сложность своего места под солнцем, и учит молодого парня в двух направлениях — школы и улицы одновременно.&#39;,
 &#39;Название: Однажды в Америке. Отзыв: Естественно вы из всего вышеперечисленного не поймете, почему этот фильм настолько потрясающ. Весь ШИК там в том, что это просто надо видеть, чувствовать, сопереживать, понимать, в общем, все то чем некоторые не очень любят заниматься.\n\nРоберт Де Ниро. Многие могут со мной не соглашаться, но Де Ниро потрясающе играет Лапшу. Играет потрясающе и в зрелости и в старости, он спокоен, но в то же время может так рассвирепеть, что мало никому не покажется. Смотря как Де Ниро играет Лапшу понимаешь, что невозможно представить никого другого в этой роли.\n\nДжеймс Вудс. А вот насчет этого замечательного актера практически все единодушны во мнении, что Макс у Джеймса Вудса получился просто великолепный. Он настолько шикарно играет Макса, что ему не просто ВЕРИШЬ, а ВЕРИШЬ ПОЛНОСТЬЮ. Макс просто великолепен, он умен, хитер, расчетлив, в чем-то притягательный, в чем-то отталкивающий. Вудс гениален в роли Макса.&#39;,
 &#39;Название: Бронкская история. Отзыв: Великолепная криминальная драма, которая познакомила нас с увлекательной историей о жизни людей в эпоху расцвета преступного мира в США. Культовый фильм, снятый непревзойденным Робертом де Ниро\n\n9 из 10&#39;,
 &#39;Название: Военный ныряльщик. Отзыв: Фильм очень понравился, Роберт Де Ниро сыграл свою роль на высшем уровне.\n\nЦветной(Куба Гудинг) стремился стать ныряльщиком, он с детства любил плавать.\n\nРоберт Де Ниро сыграл роль строгого ботсмана, когда он попал в школу водолазов он выжимал все соки с учеников, он считал себя лучшим водолазом и требовал от учеников то же самое.\n\nФильм считаю сильным и отличным.\n\nМоя оценка 10/10&#39;,
 &#39;Название: Пробуждение. Отзыв: Роберт Де Ниро. Хочется выделить отдельно. Он так же бесподобен как и все, но…\n\nНасколько же нетипична для него такая роль(по крайней мере для меня). Когда я понял что он будет играть одного из пациентов то насторожился, все-таки я привык к Де Ниро-гангстеру в многочисленных фильмах, он же молодой дон Корлеоне в конце концов, а тут вдруг пациент неврологической клинике. Но лишний раз получил подтверждение что талант есть талант. Он столь же убедителен в роли человека с ограниченными возможностями, как и в роли гангстера. Хотя в эпизоде где его посадили в карцер, для буйных и он начал диктовать свои условия врачам и заручился поддержкой остальных больных у меня сразу мелькнула мысль — вот они бандитские корни, и тут умудрился банду сколотить. В общем весь фильм получал огромнейшее удовольствие от его игры, она меня заинтриговала не меньше чем сюжет фильма.&#39;,
 &#39;Название: Однажды в Америке. Отзыв: Роберт Де Ниро один из моих любимых актеров. «Лапша» — один из лучших его образов. Сыграл он просто замечательно. Он лучший итальяно-американский актер. Ему мафиози (или прочих преступников) с рождения дано играть! Ах, да, чуть не забыл упомянуть не менее талантливого актера Джеймса Вудса, сыгравшего роль «Макса». Если честно, мне его была очень жалко. Финальная сцена фильма, где происходит решающий разговор между «Лапшой» и «Максом» просто гениальна, актеры превзошли самих себя.&#39;,
 &#39;Название: Бронкская история. Отзыв: Только жалеть приходится о том, что Де Ниро так редко выступает в амплуа режиссера. Потому что каждый из трех сделанных им фильмов заслуживает самого пристального внимания. И первый из них, «Бронкская история», отнюдь не исключение. Скорее, даже наоборот, пока это его лучший фильм.\n\nВ истории мальчишки из Бронкса, парня-макаронника, нет ничего особенного, из ряда вон выходящего. Он не какой-то там супер-герой. И жизнь вокруг — обычная, будничная. Однако это-то и есть самый настоящий талант — не выдумывать какую-то, не существующую жизнь, а уметь видеть настоящую, но так ясно и так глубоко, как не видят ее другие. И вместе с тем уметь показать ее так этим другим.\nКроме всего прочего, в картине есть момент, поистине гениальный. Если бы он составлял ее единственное достоинство, то и ради него одного стоило бы смотреть «Бронкскую историю» и рекомендовать ее другим.&#39;,
 &#39;Название: Крестный отец 2. Отзыв: Каждый входит в число лучших американских фильмов. Роберт де Ниро, говоривший весь фильм только по-итальянски, получил первого Оскара за роль молодого Вито. Он играет его полным достоинства и следующим своему коду чести человеком, трудолюбивым, любящим и преданным отцом и мужем, который нe остановится ни перед чем, чтобы сделать свою семью счастливой — так, как он видит счастье.&#39;,
 &#39;Название: Крестный отец 2. Отзыв: Нельзя не упомянуть важнейшую составляющей триумфа КО2 — актёрский состав и актёрские работы, которые должны изучаться студентами актёрского мастерства, мечтающими стать не звёздами, но АРТИСТАМИ. Аль Пачино был в расцвете таланта в 1970х годах, что и отмечено четырьмя подряд оскаровскими номинациями (1973—1976). Так вот, Майкл Корлеоне в КО2 -это его мастер-класс. Я не поклонница поздних работ Пачино, включая его наконец-то отмеченную статуэткой работу в фильме «Запах Женщины». Он много кричит, он переигрывает, но все крики и рыки не скажут больше, чен один безмолвный и бесконечный взгляд, в сцене празднования Нового Года в Гаване, во время которого его лицо действительно темнеет на наших глазах. Так разбиваются сердца. Джон Казале (Фредо), разбивший серце Майклу и нам зрителям своей трагически короткой творческой жизнью, в которой он успел сыграть всего лишь в пяти фильмах, но каких! Каждый входит в число лучших американских фильмов. Роберт де Ниро, говоривший весь фильм только&#39;,
 &#39;Название: Славные парни. Отзыв: Джими. Я уже видел столько фильмов с участием Роберта Де Ниро, что казалось бы удивляться нечему. Этот актёр превосходно показывал самые разные образы, от комедий до сильных драм. И, тем не менее, Роберт удивляет. Он полностью раскрывается в фильме. Его персонаж — это гангстер со стажем, который задействовал себя во всех сферах криминальной жизни общества. Его предпочтение — это ограбления, однако, если потребуется, он способен на всё, в том числе и на убийство.&#39;]
</pre></div>
</div>
</div>
</div>
<p>Попробуем какие-нибудь другие вопросы. На вопрос о наиболее оскароносном фильме получили ответ Титаник. Модель ответила так из-за того, что из всех фильмов в <em>контексте</em> у него больше всего оскаров.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;Какой фильм выиграл больше всего оскаров?&#39;</span>
<span class="n">answer</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Фильм &quot;Титаник&quot; выиграл наибольшее количество Оскаров - 11.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; ; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Название: Амадей. Отзыв: Шикарные декорации, потрясающая музыка, отличная актерская игра, прекрасный сценарий оставляют просто великолепные ощущения после просмотра данного киношедевра. Да и 8 «Оскаров» и 3 номинации говорят сами за себя. \n\nОдин из наиболее успешных фильмов в истории Киноакадемии. Браво Милош Форман, браво актеры, браво Моцарт!&#39;,
 &#39;Название: Король говорит!. Отзыв: После абсолютно немотивированных главных победителей «Оскара» последних двух лет — «Миллионера из трущоб» и «Повелителя бури» — объявления победителя 2011 года я ждал с изрядной долей опасения. К счастью, опасения оказались напрасными: посмотрев позднее фильм «Король говорит!» я, по крайней мере, могу понять логику рассуждений американских киноакадемиков и согласиться что лента об английском монархе — фильм достойный и стал лучшим по праву. Хотя, признаюсь, я больше бы обрадовался триумфу умного, психологически тонкого «Начала» Кристофера Нолана или простой, но вместе с тем гениальной в своей простоте «Железной хватки» братьев Коэнов. Кстати, последние в последние (простите за тавтологию) годы снимают очень интересные, качественные фильмы, вот и прошлый «Оскар» за лучший фильм я бы вполне мог отдать их «Серьезному человеку».&#39;,
 &#39;Название: 12 разгневанных мужчин. Отзыв: Кстати фильм который часто попадает в различные рейтинги и кинотопы лучших (естественно это о «12 разгневанных мужчинах») в свое время был удостоен всего лишь 3 номинаций на Оскар (фильм, режиссер, адаптированный сценарий) но ничего не получил так как проиграл «Мосту через реку Квай».\n\n8 из 10&#39;,
 &#39;Название: Титаник. Отзыв: Ещё с интересом узнал о количестве номинаций фильма. Ведь по правилам «Оскара», любой фильм может рассчитывать максимум на 14 из большего числа наличествующих номинаций. Предыдущий результат был только у одного фильма — «Всё о Еве», но только с результатом в 6 статуэток. По «Золотым глобусам» и MTV в 1998м фильм также обошёл конкурентов. А вот с английской BAFTA получилось какое-то недоразумение. Из 10-и номинаций — ничего. Видимо, для британцев это была «очередная история от американского режиссёра „Терминатора“ и „Правдивой лжи“». Впрочем, подобная ситуация была и у третьего «Властелина колец». Ну, американцы на «Оскаре», «Глобусе» и MTV восстанавливают справедливость!\n\nФильм, ознаменовавший веху в истории мирового кино.\n\n10 из 10&#39;,
 &#39;Название: Форрест Гамп. Отзыв: «Форрест Гамп» имел огромный успех и получил 6 Оскаров, в том числе: за «Лучший фильм», за «Лучшую режиссуру», за «Лучшую мужскую роль», за «Лучшие визуальные эффекты», за «Лучший монтаж» и за «Лучший адаптированный сценарий». Форрест Гамп не оставил шанса на победу Квинтону Тарантино с его блестящей хипповой чёрной комедией «Криминальное чтиво» и ещё одному бесспорному фавориту, «Побегу из Шоушенка» Фрэнка Дарабонта, экранизации повести Стивена Кинга. Я думаю, в этом одна из причин, отчего после-оскаровская судьба Форреста в какой-то мере противоречива.&#39;,
 &#39;Название: Король говорит!. Отзыв: «Король говорит!» — один из немногих фильмов, с чьими наградами, с похвалами в чей адрес я согласна. Это действительно картина на века. Он стала таковой под руководством Тома Хупера, и, даже если он вообще ничего не снимет больше, он достоин всех наград мира за один этот фильм. Я признаюсь, что, когда Сандра Баллок объявила Колина Ферта как победителя в номинации «Лучший актер», я пережила вместе с ним этот триумф. А каким будет Лучший фильм 2011 года, я и не сомневалась. Я не хочу сказать, что конкурентов у него не было в плане зрелищности. Конкурентов не было в плане всего остального — актерской игры, режиссуры и сценария. Какой еще из заявленных кандидатов мог соперничать с «Королевской речью» (именно таково оригинальное название фильма)?! Я радовалась за Тома Хупера, Колина Ферта, Хелену Бонэм-Картер, Джеффри Раша, Александра Деспла и всех тех, кто вложил частицу своего таланта в этот фильм. И пусть завистники назовут результат Оскара 2011 предсказуемым, а победу британской ленты&#39;,
 &#39;Название: Титаник. Отзыв: Надо сказать, что 11 Оскаров взялось вовсе не от популярного названия, ибо это был уже далеко не первый фильм о великой трагедии. На этот фильм были потрачены огромные средства, но собрал этот фильм самую большую кассу в истории. Режиссер Джеймс Кэмерон смог побить собственный рекорд только сняв в 2009 году фильм «Аватар». И кассовые сборы возникли не на пустом месте. Я бы и сейчас с удовольствием сходил бы в кино на этот гениальный фильм.\n\nФильм пронизывает тебя насквозь. Не хочется искать какие-то недостатки. Ляпы, которые изначально вовсе не бросаются в глаза, совершенно не портят впечатления от картины! Мы видим огромный корабль, на котором мечтали оказаться, безусловно, миллионы человек… И потом эти миллионы будут Бога благодарить за то, что эта их глупая, изначально греховная мечта — не сбылась. Понимая все это, под гениальную песню «My heart will go on» в титрах — сложно сдержать слезы.&#39;,
 &#39;Название: Король говорит!. Отзыв: Я был уверен на 99 процентов, что данный фильм победит сразу в нескольких номинациях на премию «Оскар». Собственно так и произошло. Четыре премии «Оскар» получил фильм «Король говорит!» И конечно же самой главной победой этого фильма является победа в номинации «Лучший фильм». Я хочу поздравить Тома Хупера за победу в номинации «Лучший режиссёр». Конечно же я рад за Колина Фёрта. Рад, что он получил Оскар за «Лучшую главную мужскую роль». И я поздравляю Дэвида Сайдлера, который одержал победу в номинации «Лучший оригинальный сценарий».\n\nНу а мне остается только поставить оценку. И этой оценкой будет, конечно же…\n\n10 из 10\n\nБраво!&#39;,
 &#39;Название: Форрест Гамп. Отзыв: Фильм заслуженно победил в шести номинациях на Оскар, это поистине один из лучших фильмов Голливуда, который можно будет смотреть и через двадцать лет, а фильм будет все так же интересен! \n\n10 из 10&#39;,
 &#39;Название: Малышка на миллион. Отзыв: К большинству фильмов в Голливуде, которые в последнее время получают больше всего Оскаров за год, я отношусь поначалу скептически. Почему? Да потому что в наших широтах эти фильмы почему-то остаются без должного внимания — их смотрят мало да и «крутят» их уже после того, как им вручили высшую награду. Но, оказывается, эти фильмы воистину достойны просмотра и высших наград «киноакадемий». Вот яркий пример — фильм «Малышка на миллион», лауреат 4 премий «Оскар», включая «Лучший фильм 2004 года». Режиссером фильма (а заодно и исполнителем главной роли) выступил всем известный актер и режиссер Клинт Иствуд, чьи фильмы уже не раз попадали в претенденты на «Оскар».&#39;]
</pre></div>
</div>
</div>
</div>
<p>Благодаря промпту модель не отвечает на вопрос, если в контексте нет нужной информации!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;Сколько лет Тому Холланду?&#39;</span>
<span class="n">answer</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">answer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Извините, но я не могу предоставить вам информацию об возрасте Тома Холланда, так как все отзывы, которые вы указали, относятся к другим фильмам и не содержат информации о его возрасте.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; ; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Название: Гран Торино, отзыв: Спросите у себя — сколько вы знаете режиссеров, способных снимать по два фильма в год? Сколько вы знаете режиссеров, способных снимать по два фильма в год, которые с легкостью претендуют в «топ-20 года». Сколько должно быть лет такому режиссеру? Клинту Иствуду уже семьдесят восемь, но его работоспособности позавидует любой начинающий режиссер, готовый трудиться годами без сна.&#39;,
 &#39;Название: Начало, отзыв: И на закуску из мужчин я оставила Тома Харди. Тут ооо и только ооо. Потом я очнулась и стала следить за тем, как он играет. Вообще, появившись в костюме какого-то местного клоуняки или назовём этот образ — первый парень на селе — я недоверчиво покрутила головой. Потом гляжу — мой мальчик таки выбился в большое кино к 32 годам. Успех. Отменно отыграл и причём реально большую роль, показав, что способен быть и самостоятельным экшн-героем. Я у экрана просто сходила с ума. Хорошо, что хоть выла тихонько, а не в полную силу.\n\nБарышни тоже не подкачали. Пейдж, если не брать в расчет её походку «ковбойша, высланная из Мексики, где 20 лет скакала без минуты отдыха», замечательна. Глаза невероятно пронзительны, да и смотрится органично. Котийар как раз из той породы женщин, которые становятся роковыми. И тут парадокс — тоже убедительна.&#39;,
 &#39;Название: Укрощение строптивого, отзыв: -сколько тебе лет?\n-25\n-тебе столько не дашь\n-конечно\n-я думал 26\n\nОдним словом, советую всем посмотреть этот фильм, уверена, что не пожалеете\n\nА фильму\n\n10 из 10&#39;,
 &#39;Название: Поймай меня, если сможешь, отзыв: И в очередной раз я преклоняю голову перед Стивеном Спилбергом и всей его командой. Фильм на мой взгляд получился шедевром, ну раз над ним работали люди, знающие толк в своём деле.\n\nВо — первых, потрясающая режиссура. Спилберг на столько точно передал внутренний мир главного героя, что его радости и беды отражаются и на наших чувствах.\n\nВо — вторых, изумительная игра актёров. Леонардо ДиКаприо, Том Хэнкс, Кристофер Уокен и другие звёзды этого фильма заслуживают высоких похвал в свой адрес. Лео отлично сыграл мошенника, подростка, заключённого и т. д. Сколько ему лет было в начале фильма? 17? А сколько в конце? Совсем не просто сыграть одного и того же человека в разных возрастах.\n\nКристофер Уокен показал нам успешного человека, у которого было всё: большой дом, шикарная машина, красавица жена. Но в итоге он потерял всё, что имел и берёг.\n\nТом Хэнкс одел маску того, который готов пожертвовать всем, что у него есть, лишь бы поймать мошенника.&#39;,
 &#39;Название: Шерлок Холмс, отзыв: Образ лондонского сыщика изменился до неузнаваемости. Даже его внешний вид и наряд изменились. Теперь Холмс не в возрасте и его гениальность не кажется мудростью, появившейся после стольких лет жизни. Нет, Шерлоку образца 2009 года не больше 45 лет и он только начинает бурно жить на экранах. От опрятности его внешнего вида не осталось и следа — герою теперь всё равно в чём выходить на грязные лондонские улицы, забитыми каретами и рабочими. Шляпы на голове только чужие и ворованные. Трубку он курит только иногда, а его рассудительность сменилась юмором бесчувственного, так сказать, ублюдка. Если раньше Холмс казался в первую очередь хорошим человеком, готовым придти на помощь, то теперь это гениальная личность со множеством странностей, в том числе нелюбовью солнечного света. В его квартире царствует бардак подростка. Чтобы развлечь себя он не играет на скрипке и не читает книг, а пытается изобретать и, что ещё похлеще, идёт набивать морды в нелегальные кулачные бои со ставками. Его&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="multi-query">
<h1>Multi-Query<a class="headerlink" href="#multi-query" title="Link to this heading">#</a></h1>
<p>Попробуем расширить контекст, добавив перефразированные вопросы.</p>
<img src="https://i.ibb.co/H4qV7YH/multi-query.png" alt="drawing" width="550"/>
<p>Для перефразирования будем использовать ту же модель, которой генерируем текст, но с новым промптом.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rephrase_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Твоя задача написать </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> разных вариаций вопроса пользователя для того,</span>
<span class="s2">чтобы по ним получить релевантные документы из векторной базы данных.</span>
<span class="s2">Ты должен переформулировать вопрос с разных точек зрения.</span>
<span class="s2">Это поможет избавить пользователя от недостатков поиска похожих документов на основе расстояния.</span>
<span class="s2">Вопрос пользователя сфокусирован на теме кино.</span>
<span class="s2">Напиши ТОЛЬКО вариации вопроса и больше ничего, разделяя их символом новой строки </span><span class="se">\\</span><span class="s2">n.</span>
<span class="s2">НЕ пиши ответ на сам вопрос.</span>
<span class="s2">-----------------</span>
<span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">generation_pipeline</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generated_text&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n+&#39;</span><span class="p">,</span> <span class="n">queries</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="n">rephrase_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">all_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rephrased_query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
        <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rephrased_query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">all_chunks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected_chunks</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Название: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">all_chunks</span><span class="p">]</span>

    <span class="c1"># оставляем только уникальные тексты</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">queries</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;Посоветуй легкую комедию&#39;</span>
<span class="n">answer</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">queries</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>На основе представленных отзывов и их обобщения, могу предложить следующие легкие и комедийные фильмы:

1. &quot;Любовь и голуби&quot;. Этот фильм, написанный автором Лайонелом Купером, часто называют лучшей работой этого режиссера. Он известен своим уникальным юмором и легкостью в рассказе истории.

2. &quot;Бриллиантовая рука&quot;. Этот фильм стал культовым благодаря своей неожиданной исторической реальностью и оригинальным персонажам.

3. &quot;Пролетая над гнездом кукушки&quot;. Это фильм-триллер с увлекательной историей, где актеры показывают себя в самых разных профессиях.

4. &quot;Рататуй&quot;. Этот фильм - это настоящая шутка, и его создатели стремятся удивить вас всеми возможными способами.

5. &quot;Семь жизней&quot;. Этот фильм, как правило, считается наиболее серьезным и серьезным в репертуаре кинематографиста Эмилии Грант.

Однако, стоит отметить, что многие люди могут найти фильм &quot;Обитаемый остров&quot; очень веселым и забавным, особенно если они предпочитают комедию.

Также важно помнить, что каждый человек имеет свои предпочтения и любимые фильмы, поэтому оценка каждого фильма будет индивидуальной и зависит от личного восприятия каждого конкретного человека.
</pre></div>
</div>
</div>
</div>
<p>Качество Multi-Query во много зависит от способности LLM перефразировать текст. Если она справляется плохо, то появятся нерелевантные запросы. Это можно исправить, добавив фильтрацию по соответствию входному запросу.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">queries</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Попробуйте рассмотреть следующие варианты вопроса:&#39;,
 &#39;1) &quot;Существуют ли любые фильмы-комедии, которые можно описать как легкие?&quot;&#39;,
 &#39;2) &quot;Чем могу заняться, чтобы найти фильм-комедию без особого труда?&quot;&#39;,
 &#39;3) &quot;Какие из популярных фильмов-комедий считаются наиболее легкими?&quot;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; ; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Название: Бойцовский клуб. Отзыв: пересматривая который можно открыть что-то новое и каждый раз задумываясь о просмотренном?Или это всего лишь фильм на определенное время, удачно подвернувшийся когда надо?&#39;,
 &#39;Название: Братц. Отзыв: Советую посмотреть. \n\n\n\n6 из 10&#39;,
 &#39;Название: Бриллиантовая рука. Отзыв: Что можно еще добавить? Разве только то, что когда слышишь название этого фильма, или одну из множества цитат, на которые буквально порвали ленту — сразу же начинаешь улыбаться. А на душе становится легко и весело. \n\nТак нужны ли иные критерии оценки фильма?&#39;,
 &#39;Название: В джазе только девушки. Отзыв: Очаровательный фильм! Такой и должна быть классическая комедия: интересной, игривой и легкой, как бизе!&#39;,
 &#39;Название: В джазе только девушки. Отзыв: любят погорячее») отличается, лёгким и беззаботным юмором, этот фильм можно смотреть в любом возрасте, в любом настроении, совершенно разным людям.&#39;,
 &#39;Название: Любовь и голуби. Отзыв: И самое главное герои фильма отвечают на эти вопросы. Смешно, но поучительно!&#39;,
 &#39;Название: Начало. Отзыв: Ну и в итоге вопрос — за что оценку то ставить? ладно, попробую…\n\n1 из 10&#39;,
 &#39;Название: Обитаемый остров. Отзыв: Не хочу ставить оценки, но по-моему сходить на фильм стоит, просто чтобы улыбнуться, тихой такой доброй улыбкой.&#39;,
 &#39;Название: Одиннадцать друзей Оушена. Отзыв: У меня есть несколько вопросов.\n\n1) Жанр. Попытки совместить комедию, криминальную драму, триллер, боевик и т. д. явление повсеместное в современном кино, но в каждой цельной ленте должен просматриваться какой-то жанровый вектор, а остальное — лишь украшение. Здесь же: для комедии — не смешно, лишь местами забавно, для драмы — предсказуемо хэппиэндово, для криминала — слишком розово, для триллера — ну уж совсем ни в какие ворота…&#39;,
 &#39;Название: Пролетая над гнездом кукушки. Отзыв: ответа, но него можно ответить самому. Но чтобы выбрать путь ответа, надо сначала понять вопрос, который можно уяснить лишь посмотрев эту картину!&#39;,
 &#39;Название: Рататуй. Отзыв: А просмотрев фильм до конца, задайте себе вопрос, чтобы сделали вы, испробовав замечательное блюдо с незабываемым вкусом, вернувшим вашей душе состояние покоя и безмятежности, узнали, что его приготовила крыса!?&#39;,
 &#39;Название: Реальная любовь. Отзыв: Начнём разбор полётов:&#39;,
 &#39;Название: Семь жизней. Отзыв: Хотя здесь может быть больше подошло бы слово «привычнее», ведь большинство современных фильмов не допускают строгого деления на «чёрное» и «белое».&#39;,
 &#39;Название: Форрест Гамп. Отзыв: Но одна мысль меня волновала после всех этих рассуждений: является концовка фильма хэппи-эндом?&#39;,
 &#39;Название: Шерлок Холмс. Отзыв: 8 из 10 Так как это тот фильм, который притягивает к себе своими комедийными моментами.&#39;,
 &#39;Название: Шерлок Холмс. Отзыв: Оценка — 6 из 10&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h1>Фильтры<a class="headerlink" href="#id5" title="Link to this heading">#</a></h1>
<p>Для некоторых видов запросов можно добавить фильтры, чтобы в контекст не могли попадать документы, которые однозначно не подходят. Например, мы хотим узнать что-то про фильмы с привязкой к году. Если такой информации нет в самом отзыве, то при семантическом поиске мы не сможем ее использовать.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="sa">f</span><span class="s2">&quot;Название: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">selected_chunks</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">context</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;Составь список пяти лучших мелодрам 1980-х годов&#39;</span>
<span class="n">answer</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Список пяти лучших мелодрам 1980-х годов:

1. &quot;Привидение&quot; (The Ghosts of Christmas Past, Present and Future) - Этот фильм, написанный Ричардом Лоренсом, стал классикой 80-х. Он имеет простую сюжетку о двух младших братах, которые пытаются открыть секреты своего отца, которого они знают лишь по его фотографиям.

2. &quot;Крамер против Крамера&quot; (Cramer vs Kramer) - Это комедийный фильм, основанный на реальных событиях. Фильм рассказывает историю молодого мужчины, который вынужден разделить обязанности с матерью своей дочери, которая не хочет видеть его после развода.

3. &quot;Клуб &#39;Завтрак&#39;&quot; (Club Med) - Этот фильм является комедией с элементами драмы. Он рассказывает о группе друзей, которые вместе проводят выходные в клубе &quot;Завтрак&quot;.

4. &quot;Дневник памяти&quot; (Memoirs of a Geisha) - Этот фильм представляет собой историю о девочки, которая живет в Японии и становится проституткой. Фильм также показывает ее отношения с другим девушкой.

5. &quot;Звездный десант 3 Мародер&quot; (Starship Troopers 3: Marauder) - Этот фильм является боевым фильмом с элементами фантастики и научной фантастики. Он рассказывает историю о военных, которые отправляются на планету, где люди живут среди насекомых.
</pre></div>
</div>
</div>
</div>
<p>В этом примере модель сгенерировала не только не мелодрамы, но и фильмы неверных лет. Заметьте, что в годах присутствуют галлюцинации.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">filtered_semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">filter_years</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query_vector</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">filter_years</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;kinopoisk_e5&quot;</span><span class="p">,</span>
        <span class="n">query_vector</span><span class="o">=</span><span class="n">query_vector</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">query_filter</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">must</span><span class="o">=</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">FieldCondition</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">gte</span><span class="o">=</span><span class="n">begin</span><span class="p">,</span> <span class="n">lte</span><span class="o">=</span><span class="n">end</span><span class="p">))]</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">relevant_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">payload</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">relevant_chunks</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filter_years</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filter_years</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">filtered_semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">filter_years</span><span class="o">=</span><span class="n">filter_years</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_chunks</span> <span class="o">=</span> <span class="n">semantic_search</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Название: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Отзыв: </span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">selected_chunks</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">llm_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">context</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">answer</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filter_years</span><span class="o">=</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">1989</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Список пяти лучших мелодрам 1980-х годов:

1. &quot;Клуб &#39;Завтрак&#39;&quot;
2. &quot;Ганди&quot;
3. &quot;Назад в будущее 2&quot; 
4. &quot;Назад в будущее&quot;
5. &quot;Однажды в Америке&quot;

Эти фильмы отличаются своими уникальными сюжетами, великолепными актерскими играми, драматическими моментами и замечательным саундтреком. Каждый из них имеет свою уникальную историю, которая может вызвать волну эмоций у зрителя.
</pre></div>
</div>
</div>
</div>
<p>Заметьте, что хоть все фильмы и получились нужного года, почти все из них не мелодрамы.</p>
<section id="id6">
<h2>Резюме<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Retrieval‑Augmented Generation позволяет улучшить генерацию модели, добавляя в ее контекст полезную информацию.</p></li>
<li><p>Мы построили RAG для ответов на вопросы по фильмам, который очень неплохо справляется со своей задачей.</p></li>
<li><p>У всех методов есть свои недостатки и для RAG нет серебряной пули. Для успешной реализации очень важно понимать особенности всех методов и выбирать их в зависимости от данных и задачи.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./temp"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Урок 8. Retrieval‑Augmented Generation (RAG)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">План</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Загрузка датасета и модели</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rag">Генерация без RAG</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#retrievalaugmented-generation">Retrieval‑Augmented Generation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">RAG на отзывах</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Добавляем названия фильмов</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reranker">Reranker</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-query">Multi-Query</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Фильтры</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Резюме</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fedor Kobak
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>